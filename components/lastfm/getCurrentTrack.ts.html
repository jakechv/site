<!DOCTYPE html><html><head><meta charset="utf-8"></meta><title>getCurrentTrack.ts / Jake Chvatal</title><meta property="og:title" content="getCurrentTrack.ts"></meta><meta property="og:type" content="website"></meta><meta property="og:url" content="https://jake.isnt.online"></meta><meta property="og:site_name" content="Jake Chvatal"></meta><meta name="keywords" content="jake"></meta><meta name="author" content="Jake Chvatal"></meta><meta name="robots" content="index,follow"></meta><meta name="description" content="hi"></meta><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"></meta><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#111"></meta><link rel="icon" type="image/x-icon" href="/Users/jake/Documents/personal/site/favicons/favicon.ico"></link><link rel="apple-touch-icon" href="/Users/jake/Documents/personal/site/favicons/apple-touch-icon.png"></link><link rel="stylesheet" type="text/css" href="/resources/style.css" id="/resources/style.css"></link><link rel="stylesheet" type="text/css" href="/resources/global.css" id="/resources/global.css"></link><script src="/resources/lib.js" id="/resources/lib.js" type="module"></script><link rel="stylesheet" type="text/css" href="/resources/elements.css" id="/resources/elements.css"></link><link rel="manifest" href="/resources/manifest.json"></link><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/nord.min.css" id="dark-theme-highlight"></link><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css" id="light-theme-highlight"></link><script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js" id="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js" type=""></script><script src="/resources/elements.js" id="/resources/elements.js" type="module" defer="true"></script></head><body><link rel="stylesheet" href="/components/Sidebar/sidebar.css"></link><div class="sidebar"><div class="url-path"><b>jake.</b><span> / </span><a href="https://jake.isnt.online/components/index.html">components</a><span> / </span><a href="https://jake.isnt.online/components/LastFM/index.html">LastFM</a><span> / </span><b>getCurrentTrack.ts</b></div><script src="/components/ToggleDarkMode/toggle-dark-mode.js" type="module"></script><link rel="stylesheet" href="/components/ToggleDarkMode/toggle-dark-mode.css"></link><div class="toggle-dark-mode-container"><button class="toggle-dark-mode"></button></div></div><div class="site-body"><main><article class="wikipage"><h1 class="title-top">getCurrentTrack.ts</h1><pre><code class="language-ts has-raw-code">import { create, create2, get, $ } from &quot;/resources/lib&quot;;

/* OLD SCHOOL CURRENT PLAYING STUFF */
/* source: https://gist.github.com/trisweb/2c0c94273f653c81f34dbe8e85ad30e7 via https://www.trisweb.com/ */
/*
  /other cool idea: changing color and contrast of tbe website background when pressing a key, tapping or clicking
*/

var LFM_API = &quot;https://ws.audioscrobbler.com/2.0/&quot;;
var LFM_KEY = &quot;14eb0c0c914456103f2c584d930a44ba&quot;; // Get one at https://secure.last.fm/login?next=/api/account/create
var LFM_USER = &quot;jakeisnt&quot;;
var recentTracksUrl =
  LFM_API +
  &quot;?method=user.getrecenttracks&amp;user=&quot; +
  LFM_USER +
  &quot;&amp;api_key=&quot; +
  LFM_KEY +
  &quot;+&amp;format=json&amp;limit=1&quot;;

const LFM_TIMEOUT = 1000 * 60; // 1 minute

const lastfm = () =&gt; {
  let nowPlayingNode: HTMLElement | null = null;

  function getNowPlaying() {
    get(recentTracksUrl, (response) =&gt; {
      var currentTrack = response.recenttracks.track[0];

      // Check if it&#x27;s the same, if not then rerender
      if (
        !window[&quot;nowPlaying&quot;] ||
        window[&quot;nowPlaying&quot;].mbid != currentTrack.mbid
      ) {
        window[&quot;nowPlaying&quot;] = currentTrack;
        renderNowPlaying(currentTrack);
      }
      setTimeout(getNowPlaying, LFM_TIMEOUT);
    });
  }

  function getMetadata(track) {
    return create2(
      &quot;table&quot;,
      { className: &quot;metadata-table&quot; },
      create2(
        &quot;tr&quot;,
        {},
        create2(&quot;th&quot;, {}, &quot;Artist&quot;),
        create2(&quot;td&quot;, {}, track.artist[&quot;#text&quot;])
      ),
      create2(
        &quot;tr&quot;,
        {},
        create2(&quot;th&quot;, {}, &quot;Title&quot;),
        create2(&quot;td&quot;, {}, track.name)
      ),
      create2(
        &quot;tr&quot;,
        {},
        create2(&quot;th&quot;, {}, &quot;Listened&quot;),
        create2(&quot;td&quot;, {}, track.date[&quot;#text&quot;])
      )
    );
  }

  function renderNowPlaying(track) {
    console.log(track);
    if (nowPlayingNode) {
      nowPlayingNode.remove();
    }

    nowPlayingNode = create(
      &quot;div&quot;,
      {
        className: &quot;now-playing&quot;,
        href: track.url,
        target: &quot;blank&quot;,
      },
      $(&quot;.lastfm-now-playing-box&quot;)
    );

    const nowPlayingImage = create(
      &quot;img&quot;,
      {
        className: &quot;np-image&quot;,
        width: &quot;128&quot;,
        height: &quot;128&quot;,
        src: track.image.slice(-1)[0][&quot;#text&quot;],
      },
      nowPlayingNode
    );

    // const currently = track[&quot;@attr&quot;] &amp;&amp; track[&quot;@attr&quot;].nowplaying == &quot;true&quot;;

    if (nowPlayingNode) {
      nowPlayingNode.appendChild(getMetadata(track));

      // const metadata = create(&#x27;div&#x27;, {
      //   class: &#x27;np-metadata&#x27;,
      //   innerHTML: getMetadata(track, currently),
      // }, nowPlayingNode);

      setTimeout(() =&gt; {
        nowPlayingNode?.setAttribute(&quot;class&quot;, &quot;now-playing loaded&quot;);
      }, 100);
    }
  }

  getNowPlaying();
};

lastfm();
</code></pre></article></main><div class="article-rhs-container"><div class="article-rhs"><div class="git-history-table-container"><span class="git-history-table-title">Revisions</span><table class="git-history-table"><thead><tr><th>Date</th><th>Hash</th></tr></thead><tbody><tr><td class="commit-date-tr">2024-04-13</td><td class="commit-link-tr">1fa3cb54</td></tr><tr><td class="commit-date-tr">2024-04-12</td><td class="commit-link-tr">e5f68a85</td></tr><tr><td class="commit-date-tr">2024-04-12</td><td class="commit-link-tr">42642b3f</td></tr><tr><td class="commit-date-tr">2024-04-12</td><td class="commit-link-tr">2b9b3c64</td></tr><tr><td class="commit-date-tr">2024-03-31</td><td class="commit-link-tr">02dca1b8</td></tr><tr><td class="commit-date-tr">2024-03-31</td><td class="commit-link-tr">2214e8fd</td></tr><tr><td class="commit-date-tr">2024-03-31</td><td class="commit-link-tr">9a544393</td></tr></tbody></table></div><div class="prev-next-up-buttons-container">Navigation<table class="prev-next-up-buttons"><tr><td>Next</td><td><a class="next-button" href="https://jake.isnt.online/components/LastFM/lastfm.ts.html">lastfm.ts</a></td></tr><tr><td>Up</td><td><a class="up-button" href="https://jake.isnt.online/components/LastFM.html">LastFM</a></td></tr></table></div></div></div></div></body></html>