<!DOCTYPE html><html><head><meta charset="UTF-8" /><title>act / filetype / src / Jake Chvatal</title><meta content="width=device-width,initial-scale=1.0" name="viewport" /><meta content="act" property="og:title" /><meta content="website" property="og:type" /><meta content="https://jake.isnt.online" property="og:url" /><meta content="Jake Chvatal" property="og:site_name" /><meta content="hi" name="description" /><meta content="Operating Systems, webring, programming, languages" name="keywords" /><meta content="Jake Chvatal" name="author" /><meta content="index,follow" name="robots" /><meta content="white" media="(prefers-color-scheme: light)" name="theme-color" /><meta content="#111" media="(prefers-color-scheme: dark)" name="theme-color" /><link href="/favicon/apple-touch-icon.png" rel="apple-touch-icon" /><link href="/manifest.json" rel="manifest" /><link href="/resources/style.css" id="/resources/style.css" rel="stylesheet" type="text/css" /><link href="/resources/global.css" id="/resources/global.css" rel="stylesheet" type="text/css" /><script id="/resources/lib.js" src="/resources/lib.js"></script><link href="/resources/elements.css" id="/resources/elements.css" rel="stylesheet" type="text/css" /><script defer="defer" id="/resources/elements.js" src="/resources/elements.js"></script><script defer="defer" id="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js" src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js"></script><script defer="defer" id="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/languages/clojure.min.js" src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/languages/clojure.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/nord.min.css" id="dark-theme-highlight" rel="stylesheet" /><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css" id="light-theme-highlight" rel="stylesheet" /></head><body><span><div class="sidebar"><div class="url-path"><a href="/">jake.</a><a href="https://isnt.online"> ~ </a><span> / </span><a href="./index.html">src</a><span> / </span><a href="./index.html">filetype</a><span> / </span><b>act</b></div><span><div class="toggle-dark-mode-container"><button class="toggle-dark-mode"></button></div><script defer="defer" id="/components/toggle-dark-mode/toggle-dark-mode.js" src="/components/toggle-dark-mode/toggle-dark-mode.js"></script><link href="/components/toggle-dark-mode/toggle-dark-mode.css" id="/components/toggle-dark-mode/toggle-dark-mode.css" rel="stylesheet" type="text/css" /></span></div><link href="/components/sidebar/sidebar.css" id="/components/sidebar/sidebar.css" rel="stylesheet" type="text/css" /></span><div class="site-body"><main><article class="wikipage"><h1 class="title-top">act</h1><pre><code class="language-clj">(ns filetype.act
  (:require
   file html components
   [instaparse.core :as insta]
   [clojure.core.match :refer [match]]))

(def parse
  (insta/parser "
<S> = TITLE,ALIAS*,(SUBTEXT | LINE | COMMENT | NEWLINE)+
TITLE = HASH,STRING,NEWLINE
ALIAS = ALIAS_NAME,EQUAL,ALIAS_NAME,NEWLINE
SUBTEXT = OPEN_PAREN,MESSAGE,CLOSE_PAREN,NEWLINE
LINE = ALIAS_NAME,COLON,MESSAGE,NEWLINE
COMMENT = DASH,STRING,NEWLINE

DASH = '-'
HASH = '#'
OPEN_PAREN = '('
CLOSE_PAREN = ')'
EQUAL = '='
COLON=': '
ALIAS_NAME=#'[a-zA-Z0-9]+'
NEWLINE='\n'
MESSAGE = (STRING|ITALIC)+
ITALIC='/'STRING'/'
STRING=#'[^()\n]+'
"))

(defn parse-script [str]
  (parse str))

(defn include-in-script? [line]
  (and
   (not= :NEWLINE (first line))
   (not= :COMMENT (first line))))

(defn third [v]
  (nth v 2))

(defn fourth [v]
  (nth v 3))

(defn script-title [script]
  [(second (third (first script)))
   (rest script)])

(defn script-alias [alias]
  (let [name (second (fourth alias))
        as (second (second alias))]
    {:name name :as as}))

(defn script-aliases [script]
  (let [[aliases rst] (split-with #(= :ALIAS (first %)) script)
        aliases (map script-alias aliases)]
    [aliases rst]))

(defn lookup-author [alias aliases]
  (:name (first (filter #(= (:as %) alias) aliases))))

(defn just-one-message-string [msg]
  (= (type (first msg)) clojure.lang.Keyword))

(defn script-message [msg]
  (let [msg (if (just-one-message-string msg) [msg] msg)]
    (for [line msg]
      (match line
        [:STRING s] [:normal s]
        [:ITALIC [:STRING s]] [:italic s]))))

(defn script-body [script aliases]
  (for [line script]
    (match line
      [:LINE
       [:ALIAS_NAME author]
       [:COLON ": "]
       [:MESSAGE message]
       [:NEWLINE "\n"]] [:line (lookup-author author aliases) (script-message message)]
      [:SUBTEXT
       [:OPEN_PAREN "("]
       [:MESSAGE content]
       [:CLOSE_PAREN ")"]
       [:NEWLINE "\n"]] [:context (script-message content)])))

(defn ->ast [parsed]
  (let [script (filter include-in-script? parsed)
        [title script] (script-title script)
        [aliases script] (script-aliases script)
        body (script-body script aliases)]
    {:title title :aliases aliases :body body}))

(defn character-selector [script]
  [:div.script-control-menu
   [:p "You're acting as "
    [:select {:name "characters" :id "characterSelector"}
     (for [alias (:aliases script)]
       [:option.character {:value (:name alias)} (:name alias)])]
    " ."]])

(defn first-author?
  "Is the author provided the first author of the script?"
  [script author]
  (= author (:name (first (:aliases script)))))

(defn message-direction [script author]
  (if (first-author? script author)
    "right"
    "left"))

(defn >2-authors? [script]
  (> (count (:aliases script)) 2))

(defn render-message [msg]
  [:span
   (for [line msg]
     (match line
       [:normal s] [:span s]
       [:italic s] [:i s]))])

(defn render-line [author message script]
  [:blockquote {:class (str "message " author " " (message-direction script author))}
   (if (>2-authors? script) [:p.message-sender author] nil)
   [:div {:class (str "message-body " author " " (message-direction script author))}
    [:p.message-text (render-message message)]]])

(defn line->html [line script]
  (match line
    [:line author message] (render-line author message script)
    [:context content] [:p.context (render-message content)]))

(defn ->html
  "Convert the script to an HTML document."
  [script path file files file-list-idx]
  [:html
   (html/head path (:title script))
   [:body
    (components/component "sidebar" file files file-list-idx nil)
    [:div.site-body
     [:main
      [:div.act-container
       (html/css "/resources/filetype/act/act.css")
       (character-selector script)
       [:article.conversation
        (for [line (:body script)]
          (line->html line script))]
       (html/script "/resources/filetype/act/act.js")]]]]])

(defn contents
  "Get the file's contents as an AST"
  [file-obj files file-list-idx]
  (-> (:source-path file-obj)
      file/read
      parse-script
      ->ast
      (->html (:target-path file-obj) file-obj files file-list-idx)))

(defn ->string [file-obj]
  (html/->string (:contents file-obj)))

(defn ->disk [file-obj]
  (file/write (->string file-obj) (:target-path file-obj)))
</code></pre></article></main><div class="article-rhs-container"><div class="article-rhs"><span><div class="git-history-table-container"><span class="git-history-table-title">Revisions</span><table class="git-history-table"><tr><th>Date</th><th>Hash</th></tr><tbody><tr><td class="commit-date-tr">2023-06-10</td><td class="commit-link-tr"><a href="https://github.com/jakeisnt/wiki/blob/3f32e164e7a8c80916f19bb14278a4a91372b541//act.clj">3f32e16</a></td></tr><tr><td class="commit-date-tr">2023-06-10</td><td class="commit-link-tr"><a href="https://github.com/jakeisnt/wiki/blob/99be24786d4823c8c1d72d811155a4fb85535032//act.clj">99be247</a></td></tr><tr><td class="commit-date-tr">2023-06-05</td><td class="commit-link-tr"><a href="https://github.com/jakeisnt/wiki/blob/2ad6367bb9b2f10ea00fb058710ea39ef742c8bb//act.clj">2ad6367</a></td></tr><tr><td class="commit-date-tr">2023-06-04</td><td class="commit-link-tr"><a href="https://github.com/jakeisnt/wiki/blob/f8302e25314168c545d65526c55007a871e845ce//act.clj">f8302e2</a></td></tr><tr><td class="commit-date-tr">2023-06-04</td><td class="commit-link-tr"><a href="https://github.com/jakeisnt/wiki/blob/31ada04a0d78da69058a5bcd8d195f047855bb71//act.clj">31ada04</a></td></tr></tbody></table></div></span><span><div class="prev-next-up-buttons-container">Navigation<table class="prev-next-up-buttons"><tr><td>Previous</td><td><a class="prev-button" href="/src/filetype/scss.clj">scss</a></td></tr><tr><td>Next</td><td><a class="next-button" href="/src/filetype/directory.clj">directory</a></td></tr><tr><td>Up</td><td><a class="up-button" href="/src/filetype">filetype</a></td></tr></table></div></span></div></div></div></body></html>