<!DOCTYPE html><html><head><meta charset="UTF-8" /><title>nix / pages / Jake Chvatal</title><meta content="width=device-width,initial-scale=1.0" name="viewport" /><meta content="nix" property="og:title" /><meta content="website" property="og:type" /><meta content="https://jake.isnt.online" property="og:url" /><meta content="Jake Chvatal" property="og:site_name" /><meta content="hi" name="description" /><meta content="Operating Systems, webring, programming, languages" name="keywords" /><meta content="Jake Chvatal" name="author" /><meta content="index,follow" name="robots" /><meta content="white" media="(prefers-color-scheme: light)" name="theme-color" /><meta content="#111" media="(prefers-color-scheme: dark)" name="theme-color" /><link href="/favicon/apple-touch-icon.png" rel="apple-touch-icon" /><link href="/manifest.json" rel="manifest" /><link href="/style.css" id="/style.css" rel="stylesheet" type="text/css" /><link href="/elements.css" id="/elements.css" rel="stylesheet" type="text/css" /><link href="/global.css" id="/global.css" rel="stylesheet" type="text/css" /><script id="/lib.js" src="/lib.js"></script></head><body><div class="site-body"><div class="sidebar"><a href="/">jake.</a><a href="https://isnt.online"> ~ </a><span> / </span><a href="./index.html">pages</a><span> / </span><b>nix</b></div><main><article class="wikipage"><h1 class="title-top">nix</h1><div><p>Nix is a functional package manager that isolates and sandboxesdependencies.</p><h1 id="tools">Tools</h1><p><a href="https://github.com/elitak/nixos-infect">nixos-infect</a>: install nixosover an existing os on digitalocean and other vps systems<a href="https://github.com/numtide/devshell">devshell</a>: universally compatiblenix-shell</p><h1 id="tutorials">Tutorials</h1><p><a href="https://nix.dev/">Resources for learning more about the Nix ecosystem</a><a href="https://nixos.org/nixos/nix-pills/pr01.html">The de-facto introduction toNixOS</a> <a href="https://ebzzry.io/en/nix/">Another greatintroduction to the Nix ecosystem</a>. This hasbetter overviews of technology like overlays than the officialdocumentation. <a href="https://www.reddit.com/r/emacs/comments/hniz19/using_nix_to_manage_emacs_packages/">Using Nix to manage Emacspackages</a>(<a href="id:62a9456a-e08a-4dc4-8e9d-310deffdb720">Emacs</a>). <a href="https://gitlab.com/rycee/configurations/-/blob/master/user/emacs.nix">Rycee'sconfiguration</a>is a good start or source of inspiration for this. <a href="https://christine.website/blog/i-was-wrong-about-nix-2020-02-10">Why Nix: Cachix, nivand nix-buildoverview</a><a href="https://spartanengineer.com/nixos/2017/09/25/basic-git-server-with-nixos.html">Set up a basic git server withNixOS</a><a href="https://rbf.dev/blog/2020/05/custom-nixos-build-for-raspberry-pis/">Set up Nix with preconfiguredSSH</a></p><p><a href="https://rzetterberg.github.io/yubikey-gpg-nixos.html">Setting up GnuPG + Yubikey on NixOS for SSHauthentication</a>:Super useful article for getting GPG to function with a yubikey and allof that. <a href="https://wiki.debian.org/Subkeys?action=show&amp;redirect=subkeys">Subkeys - DebianWiki</a> isanother great guide for creating and managing these keys.</p><p><a href="https://github.com/justinwoo/nix-shorts">Nix shorts</a>: Lots of quick andhelpful Nix tips to check out.</p><ul><li>Building derivations at the Nix REPL</li><li>Installing packages from files and derivation expressions</li><li>Working with Nix shells</li><li>Creating derivations</li></ul><h2 id="nixops">NixOps</h2><p><a href="https://sandervanderburg.blogspot.com/2015/03/on-nixops-disnix-service-deployment-and.html?m=1">An evaluation of and tutorial for Disnix andNixOps</a><a href="https://github.com/nh2/nixops-tutorial">nixops-tutorial</a>: developmentwith NixOps <a href="https://hydra.nixos.org/build/115931128/download/1/manual/manual.html#idm140737322673584">Hydra (and nixops)manual</a><a href="https://hydra.nixos.org/build/115931128/download/1/manual/manual.html#chap-introduction">nixops userguide</a></p><h2 id="macos">MacOS</h2><p><a href="https://medium.com/@zw3rk/provisioning-a-nixos-server-from-macos-d36055afc4ad">Provisioning a Nix server fromMacOS</a></p><h2 id="server">Server</h2><p><a href="https://www.youtube.com/watch?v=0tsfQskVW18&amp;app=desktop">nixos router for thehomelab</a> –useful for learning to set everything up <a href="https://www.linode.com/docs/tools-reference/custom-kernels-distros/install-nixos-on-linode/">installing and configuringnixos onlinode</a><a href="https://www.codedbearder.com/posts/nixos-terramaster-f2-221/">Running NixOS on a consumerNAS</a></p><h1 id="evaluation">Evaluation</h1><h2 id="why-nixos">Why NixOS?</h2><p><a href="https://medium.com/@jethroksy/a-year-with-nixos-113b534f446b">src</a><a href="https://myme.no/posts/2020-01-26-nixos-for-development.html">src2</a><a href="https://engineering.shopify.com/blogs/engineering/what-is-nix">what isnix?</a></p><ul><li>It's the simplest way to quickly iterate and try new programs. From\`nix-shell\` to \`nix-env\` to configuration options like\`windowManager.xmonad.enable\`, it's incredibly easy to swap parts ofyour system in very few lines of code. A lot of the grunt work hasbeen done already to ensure that common configurations are perfectlyfunctional and reproducible out of the box.</li><li>It's trivial to revert the state of your system. All it takes isbooting to a previous NixOS interation.</li><li>Declaring SystemD services happens in one place and is incrediblysimple! No more managing configuration files scattered throughout yourcomputer - you can 'metaprogram' them in Nix and serialize the filesout to disk. This applies to lots of other types of files, too; I usetemplates to manage color schemes for all of my applications, forexample.</li><li>It's incredibly simple to set up reproducible build environments forwriting and running code, especially in sandboxes when you don't wantto confuse your globally installed programs.</li></ul><h2 id="building-within-nix">Building within Nix</h2><p><a href="https://portal.mozz.us/gemini/gemini.spam.works/~emery/devlog/sigil-report.gmi">GeminiPortal</a>:An evaluation of building an operating system "underneath" Nix/OS;building bottom-up to provide some interface that adheres to the Nixproject expectations and specifications. (It failed and this is anevaluation of why).</p><h2 id="nix-vs-docker">Nix vs. Docker</h2><p><a href="https://discourse.nixos.org/t/is-there-much-difference-between-using-nix-shell-and-docker-for-local-development/807">src</a><a href="https://blog.container-solutions.com/step-towards-future-configuration-infrastructure-management-nix">src2</a><a href="https://blog.container-solutions.com/step-towards-future-configuration-infrastructure-management-nix">src3 (has good NixOps tutorialtoo)</a><a href="https://discourse.nixos.org/t/is-there-much-difference-between-using-nix-shell-and-docker-for-local-development/807">Nix vs Docker for localdevelopment</a></p><ul><li>Docker image is a snapshot of a machine that was assembled by runningcommands in a particular fashion</li><li>Making changes to the machine introduces nondeterminism; shellcommands typically fetch information from outside sources that aren'tpinned, so they change over time, and the functionality of yourcontainer will change as time progresses. Builds in Nix when properlypinned will not diverge the same way other deployment systems do.</li><li>There is no absolute guarantee that your Docker image produces thesame image every rebuild</li><li>Nix runs natively, while Docker requires a Linux virtual machine</li><li>Nix can run as any user without particular privileges</li></ul><h1 id="configs">Configs</h1><p><a href="https://github.com/jakeisnt/nix-cfg">My personal configuration</a>:</p><ul><li>Wayland enabled</li><li>Incredibly modular with thorough abstractions (in progress…)</li><li>Robust configuration of many programs, including mail server</li></ul><p><a href="https://github.com/hlissner/dotfiles">hlissner's config</a></p><ul><li>Heavily inspires mine - I forked his</li><li>Incredibly modular and allows for easy, opinionated programconfiguration</li><li>Some basic modular support and great library utilities</li><li>Consistent and comprehensive theme work</li></ul><p><a href="https://github.com/grahamc/nixos-config">Graham's NixOS config</a>:</p><ul><li>ZFS with remote backups</li><li>Wayland dedicated</li><li>Start all programs in SystemD cgroups</li><li>Erase systems on every boot</li></ul><p><a href="https://github.com/bjornfor/nixos-config">bjornfor config</a>:</p><ul><li>Lots of home automation utility configuration; zigbee, home audiomanagement, etc.</li><li>Custom derivations for tons of obscure programs corresponding to theabove</li><li>Backup service infrastructure across multiple devices</li><li>Wonky configuration for chromium, networking, VPNs, etc. Very thoroughmanagement of loads of different devices.</li><li>Has pirate radio and torrent setups as well if you're into that</li></ul><p><a href="https://github.com/bqv/nixrc">bqv</a>:</p><ul><li>Makes substantial use of nix flakes, properly managing them asoverlays</li><li>Way over my head… come back to this later! I haven't fully lookedthrough this one.</li></ul><p><a href="https://github.com/SoxinOS/soxin/">Soxin</a> and<a href="https://github.com/kalbasit/soxincfg">cfg</a>:</p><ul><li>A modular NixOS configuration system and language</li><li>(How can I improve upon these ideas?)</li><li>I haven't fully examined this one.</li></ul><p><a href="https://github.com/colemickens/nixcfg">colemickens</a>:</p><ul><li>I haven't fully examined this one either. Looks thorough, uses flakesand is constantly updated.</li></ul><p><a href="https://git.sr.ht/~aasg/nixexprs/tree">nixexprs</a>:</p><ul><li>Sourcehut-based CI configuration. Tons of good networking to inspire,plus a decent organization system. The system has IPFS, MacOSconfiguration, tons of default packages, and more. Could be used as aflake to install some of their packages; looks like it's compatiblewith NUR.</li></ul><h1 id="installation">Installation</h1><h2 id="good-practices">Good practices</h2><ul><li>Create a separate partition for all of your nix derivations, /nix</li><li>Label all of your disks so that \`hardware-configuration.nix\` isreproducible</li></ul><h2 id="initial-installation">initial installation</h2><p>worth noting that what i found the most confusing was:</p><ul><li>user configuration</li><li>vps specific, ensuring that i could remove the virtual disk (notdelete it)</li></ul><p>and log in as an unprivileged user without booting to the installationdisk</p><h3 id="partition">partition</h3><p>partition for space for nixos sudo fdisk /dev/sda new partition sector1no selection for start of partition no selection for last sector w towrite to disk</p><p>sudo mkfs.ext4 -j -L nixos /dev/sda1</p><h2 id="installation-outline">Installation Outline</h2><p>Make sure to name your disks; some configurations use some disk names bydefault.</p><p>nixos-generate-config –root /mnt</p><p>Edit /mnt/etc/nixos/configuration.nix.</p><p>Uncomment:</p><ul><li>localization for us</li><li>terminal font and keymap</li><li>timezone = America/NewYork, America/Los<sub>Angeles</sub>, etc. Theseare defined somewhere on your system.</li></ul><p>UEFI systems:</p><ul><li>You must set the option boot.loader.systemd-boot.enable to true.nixos-generate-config should do this automatically for newconfigurations when booted in UEFI mode.</li><li>Look at options with boot.loader.efi and boot.loader.systemd as well.</li></ul><p>To dual boot, supposedly boot.loader.grub.useOSProber can be set to trueto add other OS to the grub menu. This failed when I tried it (I mayhave accidentally damaged the partition table, though) but it might workfor you.</p><p>You may have to manually start the SSH daemon: \`sudo systemctl startsshd\`</p><h1 id="pro-tips">Pro tips</h1><ul><li>If the configuration isn't running properly after successfullyrefreshing it, you can use \`nixos-rebuild boot\` instead of \`…refresh\` to use the new configuration on the next boot but not enableit immediately. The \`nixos-rebuild\` utilities aside from \`switch\`all come in handy when fixing a broken configuration.</li><li>Write your own script to wrap common Nix commands. The command-lineutilities aren't great, but you can just wrap others to create yourown! (Who in their right mind would provide so many different namesfor programs \`nixos-rebuild\`, \`nix-env\`, \`nix-shell\` – it'sdifficult to know which one to even query the manpage for unlessyou're very familiar with Nix(OS) already.)</li></ul><h1 id="future-configuration-ideas">Future configuration ideas</h1><p><a href="https://askubuntu.com/questions/95716/automatically-adjust-the-volume-based-on-content">Adjust system volume based oncontext</a><a href="https://github.com/grahamc/nixos-config/tree/master/packages/recognize-thunderbolt">Thunderbolt system utility; investigate if any issuesarise</a><a href="https://github.com/gvolpe/nix-config/blob/master/home/programs/browsers/install-ext.nix">cool config trick for installing chromeextensions</a><a href="https://github.com/bjornfor/nixos-config/blob/master/cfg/software-defined-radio.nix">set up software definedradio!</a>Run programs in systemd cgroups (check out grahamc's config) <a href="https://github.com/RaitoBezarius/nix-scripts/blob/master/autoinstall/justdoit.nix">this doessome crazy things with subvolumes to automatically set up a btrfs systemwith nixos, including initialmounts</a></p><h1 id="nix-tools">Nix tools</h1><p><a href="https://github.com/Mic92/nix-update">Swiss knife for updating nixpackages.</a> <a href="https://github.com/spwhitt/nix-zsh-completions">SSH Completions forNix</a> <a href="https://github.com/chisui/zsh-nix-shell">ssh plugin thatlets you use zsh in nix-shellshell.</a> <a href="https://github.com/cleverca22/not-os">cleverca22/not-os: Anoperating system generator, based on NixOS, that,giv</a> <a href="https://github.com/NixOS/nixpkgs/issues/26067">Make a service abstractionlayer · Issue \#26067 ·NixOS/nixpkgs</a>: Abstractover systemd <a href="https://github.com/dustinlacewell/dotfiles">dustinlacewell/dotfiles: Nix configuration for all myworkstations and serv</a>workstation ux <a href="https://github.com/brainrape/nixform">brainrape/nixform: define terraform infrastructure innix</a> <a href="https://github.com/brainrape/nixos-tutorial">brainrape/nixos-tutorial:one hour, hands-on</a> <a href="https://sandervanderburg.blogspot.com/2020/06/using-disnix-as-simple-and-minimalistic.html?m=1">Sandervan der Burg
's blog: Using Disnix as a simple and minimalisticdepen</a><a href="https://blog.patchgirl.io/haskell/2020/07/13/static-haskell-binary.html">Building static Haskell binary with Nix on Linux ·PatchGirl</a><a href="https://www.reddit.com/r/haskell/comments/hzeued/neuron_06_released_futureproof_notetaking_tool/">Neuron 0.6 released: future-proof note-taking tool written in Haskell,Nix</a><a href="https://www.reddit.com/r/NixOS/comments/i2gaul/searching_and_installing_packages_in_nixos/">Searching and installing packages in NixOS -NixOS</a><a href="https://github.com/stites/haskell.nix-niv">stites/haskell.nix-niv</a><a href="https://nixos.wiki/wiki/NixOS_on_ZFS">NixOS on ZFS - NixOS Wiki</a><a href="https://elvishjerricco.github.io/2018/12/06/encrypted-boot-on-zfs-with-nixos.html">Encrypted /boot on ZFS withNixOS</a><a href="https://github.com/brainrape/nixform">brainrape/nixform</a> <a href="https://sevdev.hu/posts/2017-12-26-discovering-nix-deploying-a-simple-nginx-with-nixops.html">DiscoveringNix: Provisioning a static webserver withNixOps</a><a href="https://hugoreeves.com/posts/2019/continuously-delivering-this-blog-with-nix-hugo-and-circleci">Continuously Delivering this Blog with Nix, Hugo andCircleCI</a><a href="https://blog.container-solutions.com/step-towards-future-configuration-infrastructure-management-nix">configuring infra innix</a><a href="https://davedellacosta.com/posts/2019-03-29-why-nixos-is-hard-and-how-to-fix.html">https://davedellacosta.com/posts/2019-03-29-why-nixos-is-hard-and-how-to-fix.html</a><a href="https://github.com/dustinlacewell/dotfiles">https://github.com/dustinlacewell/dotfiles</a><a href="https://github.com/nix-community/nixos-generators">https://github.com/nix-community/nixos-generators</a> image builders fornix <a href="https://github.com/nix-community/todomvc-nix">https://github.com/nix-community/todomvc-nix</a>: canonical examplefor nix, works with or without flakes apparently.<a href="https://lemire.me/blog/2020/05/22/programming-inside-a-container/">https://lemire.me/blog/2020/05/22/programming-inside-a-container/</a>programming inside of containers<a href="https://unix.stackexchange.com/questions/522822/different-methods-to-run-a-non-nixos-executable-on-nixos">https://unix.stackexchange.com/questions/522822/different-methods-to-run-a-non-nixos-executable-on-nixos</a><a href="https://github.com/NixOS/nixpkgs/issues/26067">https://github.com/NixOS/nixpkgs/issues/26067</a> making a nix serviceabstraction layer, abstracting over systemd to produce a more genericsolution <a href="https://grahamc.com/blog/erase-your-darlings">https://grahamc.com/blog/erase-your-darlings</a><a href="https://gitlab.com/vdemeester/home">https://gitlab.com/vdemeester/home</a> this seems like a config worthlooking through! <a href="https://www.johnbcoughlin.com/posts/nix-dynamic-linking/index.html">debugging a dynamic linking bug in a nixproject</a><a href="https://github.com/danielfullmer/robotnix">danielfullmer/robotnix: Build Android (AOSP) usingNix</a><a href="id:66f8f71c-b5da-499d-84a0-765438368200">Mobile</a></p><h2 id="todo-rss-reader-written-in-haskell-and-urweb-haskell"><span class="todo TODO">TODO</span> <a href="https://www.reddit.com/r/haskell/comments/1ha5dd/rss_reader_written_in_haskell_and_urweb/">RSS reader written in Haskell and Ur/Web : haskell</a></h2><p>Captured On: \[2020-10-18 Sun 15:12\]</p><h1 id="flake-tips">Flake tips</h1><p>Do not be afraid to use the –help flag! I've learned a lotfrom it.</p><ul><li>Update a specific input: \`nix flake update –update-inputspicetify-nix\` do</li></ul><h1 id="go">Go</h1><pre><code class="language-nix">{ lib, buildGoModule, fetchFromGithub }:
# buildGoModule can be pulled in from the package
buildGoModule rec {
  pname = "mangadesk";
  version = "0.0.1";
  # fetch the derivation from wherever
  src = pkgs.fetchFromGitHub {
    owner = "darylhjd";
    repo = "mangadesk";
    rev = "v${version}";
    sha256 = "1kgb5k55fxjcf1829fkp7wyd162391am9zhfgl50a606rlsfsh7h";
  };
  # this is an intermediate sha256 that is spit out when the derivation fails, somehow. needs more work!
  # vendorSha256 = "1879j77k96684wi554rkjxydrj8g3hpp0kvxz03sd8dmwr3lh83j";
  subPackages = [ "." ];
  deleteVendor = true;
  runVend = true;

  meta = with lib; {
    homepage = "https://github.com/darylhjd/mangadesk";
    description = "Terminal client for MangaDex";
    license = licenses.mit;
    maintainers = with maintainers; [ jakeisnt ];
    platforms = platforms.linux ++ platforms.darwin;
  };
}</code></pre><h1 id="void-overlays-for-optimisation">void overlays for optimisation</h1><p><a href="https://zimbatm.com/notes/1000-instances-of-nixpkgs">Rationale</a>:overlays end up creating additional copies of \`nixpkgs\` every timethey're applied to \`nixpkgs\` and we retrieve a new package store. It'sapparently currently impossible to understand what exactly this overlayhas changed to create the new package set, so this new variable isdeclated as a new instance of nixpkgs being evaluted.</p><p>Instead, directly forward your inputs to your outputs, making sure thatall dependencies follow nixpkgs, and declaring in flakes that they allfollow the same nixpkgs deps.</p></div></article></main><div class="git-hist-table"><table><tbody><tr><td>2023-02-22</td><td><a href="https://github.com/jakeisnt/wiki/blob/ea5044fc387f17e24dcab6f3873a541cd640bfa1//home/jake/wiki/pages/nix.md">ea5044fc</a></td></tr></tbody></table></div></div></body></html>